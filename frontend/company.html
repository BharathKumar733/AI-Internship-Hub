<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Dashboard - AI Internship Recommender</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Frontend HTML files must load Socket.IO client script from backend URL -->
    <script src="https://ai-internship-hub-backend.onrender.com/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html">
                    <i class="fas fa-graduation-cap"></i>
                    <span>AI Internship Hub</span>
                </a>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Home</a>
                <a href="#internships" class="nav-link">My Internships</a>
                <a href="#applications" class="nav-link">Applications</a>
                <a href="#students" class="nav-link">Find Students</a>
            </div>
            <div class="nav-auth">
                <div class="user-menu">
                    <span class="user-name" id="userName">Company</span>
                    <button class="btn btn-outline" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard-main">
        <div class="dashboard-container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <div class="welcome-content">
                    <h1>Welcome to Your Company Dashboard</h1>
                    <p>Manage your internships, review applications, and find the best talent</p>
                </div>
                <div class="quick-stats">
                    <div class="stat-card">
                        <i class="fas fa-briefcase"></i>
                        <div class="stat-info">
                            <h3 id="totalInternships">0</h3>
                            <p>Active Internships</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-file-alt"></i>
                        <div class="stat-info">
                            <h3 id="totalApplications">0</h3>
                            <p>Total Applications</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <div class="stat-info">
                            <h3 id="totalStudents">0</h3>
                            <p>Unique Applicants</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Action Buttons -->
            <section class="action-section">
                <button class="btn btn-primary" onclick="showCreateInternship()">
                    <i class="fas fa-plus"></i>
                    Create New Internship
                </button>
                <button class="btn btn-secondary" onclick="showStudentSearch()">
                    <i class="fas fa-search"></i>
                    Find Students
                </button>
                <button class="btn btn-outline" onclick="showAnalytics()">
                    <i class="fas fa-chart-bar"></i>
                    View Analytics
                </button>
            </section>

            <!-- My Internships -->
            <section id="internships" class="dashboard-section">
                <div class="section-header">
                    <h2>My Internships</h2>
                    <button class="btn btn-outline" onclick="refreshInternships()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
                <div id="internshipsList" class="internships-grid">
                    <!-- Internships will be loaded here -->
                </div>
            </section>

            <!-- Recent Applications -->
            <section id="applications" class="dashboard-section">
                <div class="section-header">
                    <h2>Applications (<span id="applicationsCount">0</span>)</h2>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-outline" onclick="filterApplications('all')">
                            <i class="fas fa-list"></i>
                            All
                        </button>
                        <button class="btn btn-outline" onclick="filterApplications('pending')">
                            <i class="fas fa-clock"></i>
                            Pending
                        </button>
                        <button class="btn btn-outline" onclick="filterApplications('accepted')">
                            <i class="fas fa-check"></i>
                            Accepted
                        </button>
                        <button class="btn btn-outline" onclick="refreshApplications()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                <div id="applicationsList" class="applications-list">
                    <!-- Applications will be loaded here -->
                </div>
            </section>

            <!-- Student Search -->
            <section id="students" class="dashboard-section">
                <div class="section-header">
                    <h2>Find Students</h2>
                </div>
                <div class="search-filters">
                    <div class="filter-group">
                        <label>Branch:</label>
                        <select id="branchFilter">
                            <option value="">All Branches</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Business">Business</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Min CGPA:</label>
                        <input type="number" id="cgpaFilter" min="0" max="10" step="0.1" placeholder="0.0">
                    </div>
                    <div class="filter-group">
                        <label>Skills:</label>
                        <input type="text" id="skillsFilter" placeholder="JavaScript, Python, React...">
                    </div>
                    <button class="btn btn-primary" onclick="searchStudents()">
                        <i class="fas fa-search"></i>
                        Search Students
                    </button>
                </div>
                <div id="studentsList" class="students-grid">
                    <!-- Students will be loaded here -->
                </div>
            </section>
        </div>
    </main>

    <!-- Create Internship Modal -->
    <div id="createInternshipModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Internship</h3>
                <button class="close-btn" onclick="closeModal('createInternshipModal')">&times;</button>
            </div>
            <form id="createInternshipForm" class="modal-form">
                <div class="form-group">
                    <label for="internshipTitle">Internship Title</label>
                    <input type="text" id="internshipTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="internshipDescription">Description</label>
                    <textarea id="internshipDescription" name="description" rows="4" required></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="internshipDuration">Duration</label>
                        <input type="text" id="internshipDuration" name="duration" placeholder="3 months" required>
                    </div>
                    <div class="form-group">
                        <label for="internshipStipend">Stipend</label>
                        <input type="text" id="internshipStipend" name="stipend" placeholder="â‚¹2,00,000/month" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="internshipLocation">Location</label>
                        <input type="text" id="internshipLocation" name="location" required>
                    </div>
                    <div class="form-group">
                        <label for="internshipMode">Mode</label>
                        <select id="internshipMode" name="mode" required>
                            <option value="remote">Remote</option>
                            <option value="onsite">Onsite</option>
                            <option value="hybrid">Hybrid</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="requiredSkills">Required Skills (comma-separated)</label>
                    <input type="text" id="requiredSkills" name="requiredSkills" placeholder="JavaScript, Python, React, Node.js">
                </div>
                <div class="form-group">
                    <label for="branchPreference">Branch Preference (comma-separated)</label>
                    <input type="text" id="branchPreference" name="branchPreference" placeholder="Computer Science, Information Technology">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="minCGPA">Minimum CGPA</label>
                        <input type="number" id="minCGPA" name="minCGPA" min="0" max="10" step="0.1" value="7.0">
                    </div>
                    <div class="form-group">
                        <label for="maxApplications">Max Applications</label>
                        <input type="number" id="maxApplications" name="maxApplications" min="1" value="50">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate" name="endDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="applicationDeadline">Application Deadline</label>
                        <input type="date" id="applicationDeadline" name="applicationDeadline" required>
                    </div>
                    <div class="form-group">
                        <!-- Empty div to maintain the grid layout -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('createInternshipModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Internship</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer" class="message-container"></div>

    <script>
        // Utility functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showMessage(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }
        
        // Company-specific JavaScript
        let currentUser = null;
        let companyInternships = [];
        let companyApplications = [];
        let applicationFilter = 'all';
        const API_BASE = 'https://ai-internship-hub-backend.onrender.com/api';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadCompanyData();
        });

        // Initialize chat functionality
        function initChat() {
            // Chat functionality placeholder
        }

        function showCreateInternship() {
            document.getElementById('createInternshipModal').classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Load all company data
        async function loadCompanyData() {
            try {
                showLoading();
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Load all company data in parallel
                const [profileResponse, internshipsResponse, applicationsResponse, statsResponse] = await Promise.all([
                    fetch(`${API_BASE}/company/profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/company/internships`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/company/applications`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/company/dashboard`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                // Process profile data
                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    currentUser = profileData.company;
                    
                    // Update UI with company name
                    const userNameEl = document.getElementById('userName');
                    if (userNameEl) userNameEl.textContent = currentUser.name || 'Company';
                }

                // Process internships data
                if (internshipsResponse.ok) {
                    const internshipsData = await internshipsResponse.json();
                    companyInternships = internshipsData.internships || [];
                    displayCompanyInternships();
                }

                // Process applications data
                if (applicationsResponse.ok) {
                    const applicationsData = await applicationsResponse.json();
                    companyApplications = applicationsData.applications || [];
                    displayCompanyApplications();
                }

                // Process stats data
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    updateQuickStats(statsData.stats);
                } else {
                    // Fallback to calculating stats from local data
                    calculateStatsFromLocalData();
                }
            } catch (error) {
                console.error('Error loading company data:', error);
                showMessage('Failed to load dashboard data. Please try refreshing the page.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Fallback function to calculate stats from local data
        function calculateStatsFromLocalData() {
            try {
                // Calculate stats from local data
                const totalInternships = companyInternships.length;
                const activeInternships = companyInternships.filter(i => i.isActive !== false).length;
                const totalApplications = companyApplications.length;
                
                // Get unique applicants by counting unique student IDs
                const uniqueApplicants = [...new Set(companyApplications.map(app => app.student?._id))].length;
                
                const stats = {
                    totalInternships: totalInternships,
                    activeInternships: activeInternships,
                    totalApplications: totalApplications,
                    pendingApplications: companyApplications.filter(app => app.status === 'pending').length,
                    acceptedApplications: companyApplications.filter(app => app.status === 'accepted').length
                };
                
                updateQuickStats(stats);
            } catch (error) {
                console.error('Error calculating stats from local data:', error);
            }
        }

        function updateQuickStats(stats) {
            try {
                // Update stats with safe defaults
                const totalInternships = stats?.totalInternships || 0;
                const totalApplications = stats?.totalApplications || 0;
                const uniqueApplicants = stats?.uniqueApplicants || 
                    [...new Set(companyApplications.map(app => app.student?._id))].filter(id => id).length || 0;

                const totalInternshipsEl = document.getElementById('totalInternships');
                const totalApplicationsEl = document.getElementById('totalApplications');
                const totalStudentsEl = document.getElementById('totalStudents');

                if (totalInternshipsEl) totalInternshipsEl.textContent = totalInternships;
                if (totalApplicationsEl) totalApplicationsEl.textContent = totalApplications;
                if (totalStudentsEl) totalStudentsEl.textContent = uniqueApplicants;
            } catch (error) {
                console.error('Error updating quick stats:', error);
            }
        }

        function displayCompanyInternships() {
            try {
                const container = document.getElementById('internshipsList');
                if (!container) return;

                // Ensure internships is an array
                const internships = Array.isArray(companyInternships) ? companyInternships : [];

                if (internships.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-briefcase"></i>
                            <h3>No Internships</h3>
                            <p>Create your first internship opportunity!</p>
                            <button class="btn btn-primary" onclick="showCreateInternship()">
                                <i class="fas fa-plus"></i>
                                Create Internship
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = internships.map(internship => {
                    // Safe access to properties with defaults
                    const title = internship.title || 'Internship';
                    const description = internship.description || 'No description available';
                    const location = internship.location || 'Not specified';
                    const duration = internship.duration || 'Not specified';
                    const stipend = internship.stipend || 'Not specified';
                    const mode = internship.mode || 'onsite';
                    const applicationDeadline = internship.applicationDeadline || new Date();
                    const currentApplications = internship.currentApplications || 0;
                    const maxApplications = internship.maxApplications || 100;
                    const isActive = internship.isActive !== undefined ? internship.isActive : true;
                    const id = internship._id || '';

                    // Status badge styling
                    const statusClass = isActive ? 'active' : 'inactive';

                    return `
                        <div class="internship-card">
                            <div class="internship-header">
                                <h3>${title}</h3>
                                <span class="status-badge ${statusClass}">
                                    ${isActive ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <p class="internship-company">Company: ${currentUser?.name || 'Your Company'}</p>
                            <p class="internship-description">${description.substring(0, 150)}${description.length > 150 ? '...' : ''}</p>
                            <div class="internship-details">
                                <div class="detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${location}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-clock"></i>
                                    <span>${duration}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-dollar-sign"></i>
                                    <span>${convertToINR(stipend)}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-users"></i>
                                    <span>${currentApplications}/${maxApplications} applications</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>Deadline: ${new Date(applicationDeadline).toLocaleDateString()}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-laptop"></i>
                                    <span>${mode}</span>
                                </div>
                            </div>
                            <div class="internship-actions">
                                <button class="btn btn-outline" onclick="viewInternshipDetails('${id}')">
                                    <i class="fas fa-eye"></i>
                                    View
                                </button>
                                <button class="btn ${isActive ? 'btn-warning' : 'btn-success'}" onclick="toggleInternshipStatus('${id}', ${isActive})">
                                    <i class="fas fa-${isActive ? 'pause' : 'play'}"></i>
                                    ${isActive ? 'Deactivate' : 'Activate'}
                                </button>
                                <button class="btn btn-danger" onclick="deleteInternship('${id}')">
                                    <i class="fas fa-trash"></i>
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error displaying internships:', error);
                showMessage('Failed to display internships', 'error');
            }
        }

        function displayCompanyApplications() {
            try {
                const container = document.getElementById('applicationsList');
                if (!container) return;

                // Update applications count
                const applicationsCountEl = document.getElementById('applicationsCount');
                if (applicationsCountEl) {
                    applicationsCountEl.textContent = companyApplications.length;
                }

                // Filter applications based on current filter
                let filteredApplications = companyApplications;
                if (applicationFilter !== 'all') {
                    filteredApplications = companyApplications.filter(app => app.status === applicationFilter);
                }

                // Ensure applications is an array
                const apps = Array.isArray(filteredApplications) ? filteredApplications : [];

                if (apps.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <h3>No Applications</h3>
                            <p>No applications match the current filter</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = apps.map(app => {
                    try {
                        // Safe access to nested properties
                        const studentName = app.student?.name || 'Student';
                        const studentEmail = app.student?.email || 'N/A';
                        const internshipTitle = app.internship?.title || 'Internship';
                        const status = app.status || 'pending';
                        const appliedAt = app.appliedAt || new Date();
                        
                        // Status badge styling
                        const statusClass = status === 'accepted' ? 'accepted' : 
                                          status === 'rejected' ? 'rejected' : 'pending';
                        
                        return `
                            <div class="application-card">
                                <div class="application-header">
                                    <div>
                                        <h3 class="application-title">${internshipTitle}</h3>
                                        <p class="application-company">${studentName} (${studentEmail})</p>
                                    </div>
                                    <span class="application-status ${statusClass}">${status}</span>
                                </div>
                                
                                <div class="application-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-calendar"></i>
                                        <span>Applied: ${new Date(appliedAt).toLocaleDateString()}</span>
                                    </div>
                                </div>
                                
                                <div class="application-footer">
                                    <div class="application-date">
                                        <i class="fas fa-clock"></i>
                                        <span>${timeAgo(appliedAt)}</span>
                                    </div>
                                    <div class="application-actions">
                                        <button class="btn btn-outline btn-sm" onclick="viewApplicationDetails('${app._id}', '${app.internshipId || app.internship?._id || ''}')">
                                            <i class="fas fa-eye"></i>
                                            View
                                        </button>
                                        ${status === 'pending' ? `
                                            <button class="btn btn-success btn-sm" onclick="updateApplicationStatus('${app.internshipId || app.internship?._id || ''}', '${app.student?._id || ''}', 'accepted')">
                                                <i class="fas fa-check"></i>
                                                Accept
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="updateApplicationStatus('${app.internshipId || app.internship?._id || ''}', '${app.student?._id || ''}', 'rejected')">
                                                <i class="fas fa-times"></i>
                                                Reject
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.error('Error processing application:', error);
                        return `<div class="application-card">Error displaying application</div>`;
                    }
                }).join('');
            } catch (error) {
                console.error('Error displaying applications:', error);
                showMessage('Failed to display applications', 'error');
            }
        }

        // Add missing utility functions
        function timeAgo(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);
                
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + ' years ago';
                
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + ' months ago';
                
                interval = seconds / 86600;
                if (interval > 1) return Math.floor(interval) + ' days ago';
                
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + ' hours ago';
                
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + ' minutes ago';
                
                return Math.floor(seconds) + ' seconds ago';
            } catch (error) {
                console.error('Error calculating time ago:', error);
                return 'Unknown time';
            }
        }

        // Utility function to convert currency to INR format
        function convertToINR(amount) {
            if (!amount) return 'Not specified';
            
            // If it's already in INR format with /month, return as is
            if (typeof amount === 'string' && amount.includes('â‚¹') && amount.includes('/month')) {
                return amount;
            }
            
            // If it's a string with â‚¹ but no /month, add it
            if (typeof amount === 'string' && amount.includes('â‚¹') && !amount.includes('/month')) {
                // Extract amount and reformat
                const inrMatch = amount.match(/[â‚¹$]?([\d,]+)/);
                if (inrMatch) {
                    const amt = parseFloat(inrMatch[1].replace(/,/g, ''));
                    const formattedINR = new Intl.NumberFormat('en-IN').format(amt);
                    return `â‚¹${formattedINR}/month`;
                }
            }
            
            // If it's a string with $, convert to INR
            if (typeof amount === 'string' && amount.includes('$')) {
                const usdMatch = amount.match(/\$([\d,]+)/i);
                if (usdMatch) {
                    const usdAmount = parseFloat(usdMatch[1].replace(/,/g, ''));
                    const inrAmount = Math.round(usdAmount * 83); // 1 USD = 83 INR
                    const formattedINR = new Intl.NumberFormat('en-IN').format(inrAmount);
                    return `â‚¹${formattedINR}/month`;
                }
            }
            
            // If it's a number or numeric string, format it as INR
            const num = parseFloat(amount);
            if (!isNaN(num)) {
                const formattedINR = new Intl.NumberFormat('en-IN').format(num);
                return `â‚¹${formattedINR}/month`;
            }
            
            return 'Not specified';
        }

        function refreshInternships() {
            loadCompanyInternships();
        }

        async function loadCompanyInternships() {
            try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch(`${API_BASE}/company/internships`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    companyInternships = data.internships || [];
                    displayCompanyInternships();
                    // Update stats after loading internships
                    calculateStatsFromLocalData();
                } else {
                    showMessage('Failed to load internships', 'error');
                }
            } catch (error) {
                console.error('Load internships error:', error);
                showMessage('Network error loading internships', 'error');
            }
        }

        async function loadCompanyApplications() {
            try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch(`${API_BASE}/company/applications`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    companyApplications = data.applications || [];
                    displayCompanyApplications();
                    // Update stats after loading applications
                    calculateStatsFromLocalData();
                } else {
                    showMessage('Failed to load applications', 'error');
                }
            } catch (error) {
                console.error('Load applications error:', error);
                showMessage('Network error loading applications', 'error');
            }
        }

        async function loadQuickStats() {
            try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                const response = await fetch(`${API_BASE}/company/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateQuickStats(data.stats);
                } else {
                    // Fallback to calculating stats from local data
                    calculateStatsFromLocalData();
                }
            } catch (error) {
                console.error('Load stats error:', error);
                // Fallback to calculating stats from local data
                calculateStatsFromLocalData();
            }
        }

        async function deleteInternship(internshipId) {
            try {
                const confirmed = confirm('Are you sure you want to delete this internship? This action cannot be undone.');
                if (!confirmed) return;

                showLoading();
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');

                const response = await fetch(`${API_BASE}/company/internships/${internshipId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showMessage('Internship deleted successfully!', 'success');
                    // Refresh the internships list
                    await loadCompanyInternships();
                    // Update stats
                    loadQuickStats();
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Failed to delete internship', 'error');
                }
            } catch (error) {
                console.error('Delete internship error:', error);
                showMessage('Network error. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        function refreshApplications() {
            loadCompanyApplications();
        }

        function showStudentSearch() {
            const studentsSection = document.getElementById('students');
            if (studentsSection) {
                studentsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                history.pushState(null, null, '#students');
            }
        }

        function showAnalytics() {
            showMessage('Analytics feature coming soon!', 'info');
        }

        async function searchStudents() {
            try {
                showLoading();
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                    
                    // Get filter values
                    const branch = document.getElementById('branchFilter').value;
                    const minCGPA = document.getElementById('cgpaFilter').value;
                    const skills = document.getElementById('skillsFilter').value;
                    
                    // Build query parameters
                    const params = new URLSearchParams();
                    if (branch) params.append('branch', branch);
                    if (minCGPA) params.append('minCGPA', minCGPA);
                    if (skills) params.append('skills', skills);
                    
                    const response = await fetch(`${API_BASE}/company/search-students?${params}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        displayStudents(data.students);
                    } else {
                        const error = await response.json();
                        showMessage(error.error || 'Failed to search students', 'error');
                    }
                } catch (error) {
                    console.error('Search students error:', error);
                    showMessage('Network error searching students', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            function displayStudents(students) {
                try {
                    const container = document.getElementById('studentsList');
                    
                    if (!students || students.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h3>No Students Found</h3>
                                <p>Try adjusting your search filters</p>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = students.map(student => `
                        <div class="student-card">
                            <div class="student-header">
                                <h4>${student.name || 'Student'}</h4>
                                <span class="student-email">${student.email || 'N/A'}</span>
                            </div>
                            <div class="student-details">
                                <div class="detail-item">
                                    <i class="fas fa-graduation-cap"></i>
                                    <span>${student.branch || 'N/A'}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-star"></i>
                                    <span>CGPA: ${student.cgpa || 'N/A'}</span>
                                </div>
                            </div>
                            ${student.skills && student.skills.length > 0 ? `
                                <div class="student-skills">
                                    <strong>Skills:</strong>
                                    <div class="skills-list">
                                        ${student.skills.slice(0, 6).map(skill => 
                                            `<span class="skill-tag">${skill}</span>`
                                        ).join('')}
                                        ${student.skills.length > 6 ? `<span class="skill-tag">+${student.skills.length - 6} more</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${student.interests ? `
                                <div class="student-interests">
                                    <strong>Interests:</strong>
                                    <p>${student.interests}</p>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error displaying students:', error);
                    showMessage('Failed to display students', 'error');
                }
            }

            function viewInternshipDetails(internshipId) {
                showMessage('Internship details feature coming soon!', 'info');
            }

            function viewApplications(internshipId) {
                showMessage('Applications view feature coming soon!', 'info');
            }

            function filterApplications(filter) {
                applicationFilter = filter;
                displayCompanyApplications();
                
                // Update button states
                document.querySelectorAll('#applications .btn-outline').forEach(btn => {
                    btn.style.background = '';
                    btn.style.color = '';
                });
                
                // Highlight the selected filter button
                if (event && event.target) {
                    event.target.style.background = '#667eea';
                    event.target.style.color = 'white';
                }
            }

            function reviewApplication(applicationId) {
                showMessage('Application review feature coming soon!', 'info');
            }

            function downloadResume(internshipId, studentId) {
                // Check both localStorage and sessionStorage for token (following best practices from memory)
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                // Create a temporary form to download with authorization
                const url = `${API_BASE}/company/download-resume/${internshipId}/${studentId}?token=${encodeURIComponent(token)}`;
                window.open(url, '_blank');
            }

            async function updateApplicationStatus(internshipId, studentId, newStatus) {
                try {
                    const statusText = newStatus === 'accepted' ? 'Accept' : 'Reject';
                    const confirmed = confirm(`Are you sure you want to ${statusText.toLowerCase()} this application?`);
                    
                    if (!confirmed) return;

                    showLoading();

                    // Check both localStorage and sessionStorage for token (following best practices from memory)
                    const token = localStorage.getItem('token') || sessionStorage.getItem('token');

                    const response = await fetch(`${API_BASE}/company/applications/${internshipId}/${studentId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    const result = await response.json();

                    hideLoading();

                    if (response.ok) {
                        showMessage(`\u2705 Application ${newStatus} successfully!`, 'success');
                        
                        // Update local data
                        const app = companyApplications.find(a => 
                            (a.internshipId === internshipId || a.internship?._id === internshipId) && 
                            (a.student?._id === studentId)
                        );
                        if (app) {
                            app.status = newStatus;
                        }
                        
                        // Refresh display
                        displayCompanyApplications();
                        loadQuickStats();
                    } else {
                        showMessage(result.error || `Failed to ${statusText.toLowerCase()} application`, 'error');
                    }
                } catch (error) {
                    hideLoading();
                    console.error('Update status error:', error);
                    showMessage('Network error. Please try again.', 'error');
                }
            }

            function viewApplicationDetails(applicationId, internshipId) {
                try {
                    // Find the application
                    const application = companyApplications.find(app => app._id === applicationId);
                    if (!application) {
                        showMessage('Application not found', 'error');
                        return;
                    }

                    // Show detailed modal or navigate to details page
                    const detailsHTML = `
                        <div style="background: white; padding: 2rem; border-radius: 15px; max-width: 650px; margin: 2rem auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h2 style="margin: 0;">Application Details</h2>
                                <span class="status-badge ${application.status}">${application.status}</span>
                            </div>
                            <hr style="margin: 1rem 0; border: none; border-top: 2px solid #f3f4f6;">
                            
                            <div style="display: grid; gap: 1rem;">
                                <div>
                                    <p style="color: #667eea; font-weight: 600; margin-bottom: 0.25rem;">Student Information</p>
                                    <p style="margin: 0.25rem 0;"><strong>Name:</strong> ${application.student?.name || 'N/A'}</p>
                                    <p style="margin: 0.25rem 0;"><strong>Email:</strong> ${application.student?.email || 'N/A'}</p>
                                    <p style="margin: 0.25rem 0;"><strong>Branch:</strong> ${application.student?.branch || 'N/A'}</p>
                                    <p style="margin: 0.25rem 0;"><strong>CGPA:</strong> ${application.student?.cgpa || 'N/A'}</p>
                                </div>
                                
                                <div>
                                    <p style="color: #667eea; font-weight: 600; margin-bottom: 0.25rem;">Internship</p>
                                    <p style="margin: 0.25rem 0;"><strong>Position:</strong> ${application.internship?.title || 'N/A'}</p>
                                    <p style="margin: 0.25rem 0;"><strong>Applied On:</strong> ${new Date(application.appliedAt).toLocaleDateString()} at ${new Date(application.appliedAt).toLocaleTimeString()}</p>
                                </div>
                                
                                ${application.student?.skills && application.student.skills.length > 0 ? `
                                    <div>
                                        <p style="color: #667eea; font-weight: 600; margin-bottom: 0.25rem;">Skills</p>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                            ${application.student.skills.map(skill => 
                                                `<span style="background: #f0f7ff; color: #667eea; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">${skill}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${application.coverLetter ? `
                                    <div>
                                        <p style="color: #667eea; font-weight: 600; margin-bottom: 0.25rem;">Cover Letter</p>
                                        <p style="padding: 1rem; background: #f8f9fa; border-radius: 8px; line-height: 1.6;">${application.coverLetter}</p>
                                    </div>
                                ` : ''}
                                
                                ${application.resumePath ? `
                                    <div style="padding: 1rem; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                                        <i class="fas fa-file-pdf" style="color: #4caf50; margin-right: 0.5rem;"></i>
                                        <strong style="color: #2e7d32;">Resume Available</strong>
                                    </div>
                                ` : `
                                    <div style="padding: 1rem; background: #fff3e0; border-radius: 8px; border-left: 4px solid #f57c00;">
                                        <i class="fas fa-exclamation-triangle" style="color: #f57c00; margin-right: 0.5rem;"></i>
                                        <strong style="color: #e65100;">No Resume Uploaded</strong>
                                    </div>
                                `}
                            </div>
                            
                            <div style="margin-top: 2rem; display: flex; gap: 0.75rem; flex-wrap: wrap; border-top: 2px solid #f3f4f6; padding-top: 1.5rem;">
                                ${application.resumePath ? `
                                    <button class="btn btn-primary" onclick="downloadResume('${internshipId}', '${application.student?._id || ''}')">
                                        <i class="fas fa-download"></i> Download Resume
                                    </button>
                                ` : ''}
                                ${application.status === 'pending' ? `
                                    <button class="btn" style="background: #10b981; color: white;" onclick="updateApplicationStatus('${internshipId}', '${application.student?._id || ''}', 'accepted'); this.closest('.overlay-modal').remove();">
                                        <i class="fas fa-check"></i> Accept Application
                                    </button>
                                    <button class="btn" style="background: #ef4444; color: white;" onclick="updateApplicationStatus('${internshipId}', '${application.student?._id || ''}', 'rejected'); this.closest('.overlay-modal').remove();">
                                        <i class="fas fa-times"></i> Reject Application
                                    </button>
                                ` : ''}
                                <button class="btn btn-outline" onclick="this.closest('.overlay-modal').remove()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Create overlay
                    const overlay = document.createElement('div');
                    overlay.className = 'overlay-modal';
                    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 10000; overflow-y: auto; display: flex; align-items: center; justify-content: center;';
                    overlay.innerHTML = detailsHTML;
                    overlay.onclick = (e) => {
                        if (e.target === overlay) overlay.remove();
                    };
                    document.body.appendChild(overlay);
                } catch (error) {
                    console.error('Error viewing application details:', error);
                    showMessage('Failed to display application details', 'error');
                }
            }

            // Handle create internship form
            document.getElementById('createInternshipForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                try {
                    showLoading();
                    const formData = new FormData(e.target);
                    const data = Object.fromEntries(formData.entries());
                    
                    // Convert comma-separated strings to arrays (with safety checks)
                    data.requiredSkills = data.requiredSkills ? data.requiredSkills.split(',').map(s => s.trim()).filter(s => s) : [];
                    data.branchPreference = data.branchPreference ? data.branchPreference.split(',').map(s => s.trim()).filter(s => s) : [];
                    
                    // Check both localStorage and sessionStorage for token (following best practices from memory)
                    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                    
                    const response = await fetch(`${API_BASE}/company/internships`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        showMessage('Internship created successfully!', 'success');
                        closeModal('createInternshipModal');
                        e.target.reset();
                        loadCompanyData();
                    } else {
                        const error = await response.json();
                        // Show more specific error message from server
                        showMessage(error.error || 'Failed to create internship', 'error');
                        console.error('Server error response:', error);
                    }
                } catch (error) {
                    console.error('Network error creating internship:', error);
                    showMessage('Network error. Please try again.', 'error');
                } finally {
                    hideLoading();
                }
            });

            // Chat functionality
            let companyId = null;

            function initChat() {
                // Event listeners for chat
                // const sendMessageBtn = document.getElementById('sendMessageBtn');
                // const messageInput = document.getElementById('messageInput');
                
                // if (sendMessageBtn) {
                //     sendMessageBtn.addEventListener('click', sendMessage);
                // }
                
                // if (messageInput) {
                //     messageInput.addEventListener('keypress', (e) => {
                //         if (e.key === 'Enter' && !e.shiftKey) {
                //             e.preventDefault();
                //             sendMessage();
                //         }
                //     });
                // }
                
                // Listen for new messages via Socket.IO
                // if (socket) {
                //     socket.on('newMessage', (data) => {
                //         console.log('New message received:', data);
                //         // If we're in a chat with this user, reload messages
                //         if (currentChatUserId === data.message.sender._id) {
                //             loadMessages(currentChatUserId, currentChatUserModel);
                //         }
                //         // Refresh conversations list to show unread count
                //         loadConversations();
                    
                //         // Update unread messages count in navbar
                //         updateUnreadMessagesCount();
                //     });
                // }
                
                // Initialize unread messages count
                // updateUnreadMessagesCount();
            }

            // Removed chat functions
            /*
            function toggleChat() {
                const chatSection = document.getElementById('chat');
                const internshipsSection = document.getElementById('internships');
                const applicationsSection = document.getElementById('applications');
                const studentsSection = document.getElementById('students');
                
                const isCurrentlyVisible = chatSection && chatSection.style.display !== 'none';
                
                if (isCurrentlyVisible) {
                    chatSection.style.display = 'none';
                    if (internshipsSection) internshipsSection.style.display = 'block';
                    if (applicationsSection) applicationsSection.style.display = 'block';
                    if (studentsSection) studentsSection.style.display = 'block';
                } else {
                    chatSection.style.display = 'block';
                    if (internshipsSection) internshipsSection.style.display = 'none';
                    if (applicationsSection) applicationsSection.style.display = 'none';
                    if (studentsSection) studentsSection.style.display = 'none';
                    loadConversations();
                }
            }

            async function loadConversations() {
                try {
                    const response = await fetch('/api/chat/conversations', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        displayConversations(result.conversations);
                    } else {
                        console.error('Failed to load conversations');
                    }
                } catch (error) {
                    console.error('Load conversations error:', error);
                }
            }

            function displayConversations(conversations) {
                const conversationsList = document.getElementById('conversationsList');
                if (!conversationsList) return;
                
                conversationsList.innerHTML = '';
                
                if (conversations.length === 0) {
                    conversationsList.innerHTML = '<p class="no-data">No conversations yet</p>';
                    return;
                }
                
                conversations.forEach(conv => {
                    const convElement = document.createElement('div');
                    convElement.className = 'conversation-item';
                    convElement.onclick = () => openChat(conv.user._id, conv.user.model, conv.user.name);
                    
                    const lastMessagePreview = conv.lastMessage ? 
                        (conv.lastMessage.content.length > 30 ? 
                            conv.lastMessage.content.substring(0, 30) + '...' : 
                            conv.lastMessage.content) : 
                        'No messages yet';
                    
                    convElement.innerHTML = `
                        <div class="conversation-info">
                            <h4>${conv.user.name}</h4>
                            <p>${lastMessagePreview}</p>
                        </div>
                        ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                    `;
                    
                    conversationsList.appendChild(convElement);
                });
            }

            async function openChat(userId, userModel, userName) {
                currentChatUserId = userId;
                currentChatUserModel = userModel;
                
                // Update chat header
                const chatHeader = document.getElementById('chatHeader');
                if (chatHeader) {
                    chatHeader.innerHTML = `
                        <h3>${userName}</h3>
                        <button class="btn btn-sm btn-outline" onclick="closeChat()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                }
                
                // Enable message input
                const messageInput = document.getElementById('messageInput');
                const sendMessageBtn = document.getElementById('sendMessageBtn');
                if (messageInput && sendMessageBtn) {
                    messageInput.disabled = false;
                    sendMessageBtn.disabled = false;
                }
                
                // Load messages
                await loadMessages(userId, userModel);
                
                // Mark messages as read
                await markMessagesAsRead(userId, userModel);
            }

            async function loadMessages(userId, userModel) {
                try {
                    const response = await fetch(`/api/chat/conversation/${userId}/${userModel}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        displayMessages(result.messages);
                    } else {
                        console.error('Failed to load messages');
                    }
                } catch (error) {
                    console.error('Load messages error:', error);
                }
            }

            function displayMessages(messages) {
                const messagesContainer = document.getElementById('chatMessages');
                if (!messagesContainer) return;
                
                messagesContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    messagesContainer.innerHTML = '<p class="no-data">No messages yet. Start a conversation!</p>';
                    return;
                }
                
                messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${msg.sender._id === companyId ? 'sent' : 'received'}`;
                    
                    messageElement.innerHTML = `
                        <div class="message-content">
                            <p>${msg.content}</p>
                            <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                        </div>
                    `;
                    
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            async function sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const content = messageInput.value.trim();
                
                if (!content || !currentChatUserId || !currentChatUserModel) return;
                
                try {
                    const response = await fetch('/api/chat/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            receiverId: currentChatUserId,
                            receiverModel: currentChatUserModel,
                            content: content
                        })
                    });
                    
                    if (response.ok) {
                        messageInput.value = '';
                        // Reload messages
                        await loadMessages(currentChatUserId, currentChatUserModel);
                        // Refresh conversations list
                        await loadConversations();
                    } else {
                        console.error('Failed to send message');
                    }
                } catch (error) {
                    console.error('Send message error:', error);
                }
            }

            async function markMessagesAsRead(userId, userModel) {
                // This is handled automatically by the backend when loading messages
                // Just refresh conversations to update unread counts
                await loadConversations();
            }

            function closeChat() {
                currentChatUserId = null;
                currentChatUserModel = null;
                
                const chatHeader = document.getElementById('chatHeader');
                if (chatHeader) {
                    chatHeader.innerHTML = '<h3>Select a conversation</h3>';
                }
                
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '';
                }
                
                const messageInput = document.getElementById('messageInput');
                const sendMessageBtn = document.getElementById('sendMessageBtn');
                if (messageInput && sendMessageBtn) {
                    messageInput.disabled = true;
                    sendMessageBtn.disabled = true;
                }
            }

            async function updateUnreadMessagesCount() {
                try {
                    const response = await fetch('/api/chat/unread-count', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        const countElement = document.getElementById('unreadMessagesCount');
                        if (countElement) {
                            if (result.count > 0) {
                                countElement.textContent = result.count;
                                countElement.style.display = 'inline';
                            } else {
                                countElement.style.display = 'none';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Update unread count error:', error);
                }
            }
            */

            // Initialize dashboard
            // loadCompanyData();
            
            // Removed chat initialization
            // initChat();
        
        // Logout function
        function logout() {
            // Check both localStorage and sessionStorage for token and user data (following best practices from memory)
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            const userStorage = localStorage.getItem('user') || sessionStorage.getItem('user');
            
            // Remove all authentication data from both storage locations
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            sessionStorage.removeItem('token');
            sessionStorage.removeItem('user');
            
            // Redirect to index page
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>